<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Store Refresh Fix</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .test-log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .test-btn {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-btn:hover {
            background: #0052a3;
        }
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Store Refresh Fix Verification</h1>
        
        <div class="test-section">
            <h2>Test Environment</h2>
            <div id="envStatus" class="test-status info">Checking environment...</div>
            <div class="test-controls">
                <button class="test-btn" onclick="checkEnvironment()">Check Environment</button>
                <button class="test-btn" onclick="runAllTests()">Run All Tests</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Store Selection Interface</h2>
            <div class="store-selection-section">
                <div class="zip-code-section">
                    <div class="zip-input-wrapper">
                        <input 
                            type="text" 
                            id="zipCode" 
                            placeholder="Enter ZIP Code" 
                            value="45202"
                            maxlength="5"
                            onkeyup="validateZipCode(this)"
                            onkeypress="handleZipEnter(event)"
                        >
                    </div>
                    <button 
                        class="find-stores-btn" 
                        onclick="findStores()"
                        id="findStoresBtn"
                    >
                        <span class="btn-icon">üîç</span>
                        Find Stores
                    </button>
                </div>
                
                <div class="store-list-section">
                    <label>Available Stores <span id="storeCount" style="display: none;"></span></label>
                    <select id="storeList" size="8" onchange="selectStore()">
                        <option value="" disabled>Enter a ZIP code to find stores</option>
                    </select>
                    
                    <div class="store-list-actions" id="storeListActions" style="display: none;">
                        <button 
                            class="refresh-stores-btn" 
                            onclick="findStores()" 
                            title="Refresh store list">
                            <span class="btn-icon">üîÑ</span>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div id="selectedStore" class="selected-store-card" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Test Results</h2>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>Debug Log</h2>
            <button class="test-btn" onclick="clearLog()">Clear Log</button>
            <div id="debugLog" class="test-log"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Load all required scripts -->
    <script src="app.js"></script>
    <script src="fix-refresh-button.js"></script>
    
    <script>
        // Test utilities
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                error: '#dc3545',
                success: '#28a745',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            const color = colors[type] || colors.info;
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        };

        const clearLog = () => {
            document.getElementById('debugLog').innerHTML = '';
            log('Log cleared');
        };

        const addTestResult = (testName, passed, details) => {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-status ${passed ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${passed ? '‚úÖ PASSED' : '‚ùå FAILED'}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            resultsDiv.appendChild(resultDiv);
        };

        // Environment check
        const checkEnvironment = () => {
            const envDiv = document.getElementById('envStatus');
            const checks = [];
            
            // Check if app.js is loaded
            checks.push({
                name: 'app.js loaded',
                passed: typeof findStores === 'function'
            });
            
            // Check if fix script is loaded
            checks.push({
                name: 'fix-refresh-button.js loaded',
                passed: typeof debugRefreshButton === 'function'
            });
            
            // Check required DOM elements
            checks.push({
                name: 'ZIP code input',
                passed: !!document.getElementById('zipCode')
            });
            
            checks.push({
                name: 'Store list',
                passed: !!document.getElementById('storeList')
            });
            
            checks.push({
                name: 'Find button',
                passed: !!document.getElementById('findStoresBtn')
            });
            
            checks.push({
                name: 'Refresh button',
                passed: !!document.querySelector('.refresh-stores-btn')
            });
            
            const allPassed = checks.every(c => c.passed);
            const failedChecks = checks.filter(c => !c.passed);
            
            envDiv.className = `test-status ${allPassed ? 'success' : 'error'}`;
            envDiv.innerHTML = allPassed 
                ? '‚úÖ Environment ready - all checks passed!'
                : `‚ùå Environment issues detected:<br>${failedChecks.map(c => `- ${c.name}`).join('<br>')}`;
            
            checks.forEach(check => {
                log(`${check.name}: ${check.passed ? 'PASSED' : 'FAILED'}`, check.passed ? 'success' : 'error');
            });
            
            return allPassed;
        };

        // Test functions
        const testRefreshButton = async () => {
            log('Testing refresh button functionality...');
            
            const refreshBtn = document.querySelector('.refresh-stores-btn');
            if (!refreshBtn) {
                addTestResult('Refresh Button Test', false, 'Button not found');
                return false;
            }
            
            // Test 1: Button visibility
            const storeListActions = document.getElementById('storeListActions');
            const initialDisplay = storeListActions.style.display;
            
            // First, load some stores
            document.getElementById('zipCode').value = '45202';
            await findStores();
            
            // Wait for stores to load
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Check if button is now visible
            const isVisible = storeListActions.style.display !== 'none';
            if (!isVisible) {
                addTestResult('Refresh Button Visibility', false, 'Button container not visible after loading stores');
                return false;
            }
            
            addTestResult('Refresh Button Visibility', true, 'Button visible after loading stores');
            
            // Test 2: Click functionality
            const storeList = document.getElementById('storeList');
            const initialStoreCount = storeList.options.length;
            
            log(`Initial store count: ${initialStoreCount}`);
            
            // Click refresh button
            refreshBtn.click();
            
            // Wait for refresh to complete
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const newStoreCount = storeList.options.length;
            log(`Store count after refresh: ${newStoreCount}`);
            
            const refreshWorked = newStoreCount > 0;
            addTestResult('Refresh Button Click', refreshWorked, 
                refreshWorked ? `Loaded ${newStoreCount} stores` : 'Failed to load stores');
            
            return refreshWorked;
        };

        const testFindStores = async () => {
            log('Testing findStores function...');
            
            document.getElementById('zipCode').value = '45202';
            const storeList = document.getElementById('storeList');
            
            try {
                await findStores();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const storeCount = storeList.options.length;
                const success = storeCount > 0 && storeList.options[0].value !== '';
                
                addTestResult('Find Stores Function', success, 
                    success ? `Found ${storeCount} stores` : 'No stores found');
                
                return success;
            } catch (error) {
                addTestResult('Find Stores Function', false, `Error: ${error.message}`);
                log(`Error in findStores: ${error.message}`, 'error');
                return false;
            }
        };

        const testButtonStates = async () => {
            log('Testing button state changes...');
            
            const findBtn = document.getElementById('findStoresBtn');
            const refreshBtn = document.querySelector('.refresh-stores-btn');
            
            if (!findBtn || !refreshBtn) {
                addTestResult('Button States Test', false, 'Buttons not found');
                return false;
            }
            
            // Monitor button state during operation
            const initialFindBtnText = findBtn.innerHTML;
            const initialRefreshBtnText = refreshBtn.innerHTML;
            
            document.getElementById('zipCode').value = '45202';
            
            // Start find operation
            const findPromise = findStores();
            
            // Check if button shows loading state
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const findBtnChanged = findBtn.innerHTML !== initialFindBtnText || findBtn.disabled;
            
            await findPromise;
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const findBtnRestored = findBtn.innerHTML === initialFindBtnText && !findBtn.disabled;
            
            addTestResult('Button State Management', findBtnChanged && findBtnRestored,
                findBtnChanged && findBtnRestored 
                    ? 'Button states change during operation' 
                    : 'Button states not properly managed');
            
            return findBtnChanged && findBtnRestored;
        };

        // Run all tests
        const runAllTests = async () => {
            log('Starting comprehensive test suite...', 'info');
            document.getElementById('testResults').innerHTML = '';
            
            // Check environment first
            if (!checkEnvironment()) {
                log('Environment check failed. Cannot proceed with tests.', 'error');
                return;
            }
            
            // Run tests sequentially
            const tests = [
                { name: 'Find Stores', fn: testFindStores },
                { name: 'Refresh Button', fn: testRefreshButton },
                { name: 'Button States', fn: testButtonStates }
            ];
            
            let passedCount = 0;
            for (const test of tests) {
                log(`Running ${test.name} test...`);
                const passed = await test.fn();
                if (passed) passedCount++;
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log(`Test suite complete: ${passedCount}/${tests.length} tests passed`, 
                passedCount === tests.length ? 'success' : 'warning');
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Test page loaded', 'info');
            checkEnvironment();
            
            // Debug button handler info
            if (typeof debugRefreshButton === 'function') {
                setTimeout(() => {
                    debugRefreshButton();
                }, 1000);
            }
        });
    </script>
</body>
</html>