<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-left: 4px solid #333; }
        .error { background: #ffe6e6; border-left-color: #d32f2f; }
        .success { background: #e8f5e8; border-left-color: #388e3c; }
        .warning { background: #fff3cd; border-left-color: #f57c00; }
        #searchResults { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 8px;
            background: white;
        }
        #searchResultsHeader {
            background: #f5f5f5;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Local Search Debug Test</h1>
    <div class="debug">
        <p>This page tests the search functionality with mock data to identify where the issue is occurring.</p>
    </div>
    
    <div>
        <input type="text" id="searchTerm" placeholder="Enter search term" value="organic vegetables">
        <button onclick="testSearch()">Test Search</button>
    </div>
    
    <div id="debugOutput"></div>
    <div id="searchResultsHeader" style="display: none;">
        <span id="resultsCount">0 products found</span>
        <span id="searchTiming"></span>
        <span id="searchQuery"></span>
    </div>
    <div id="noResultsState" style="display: none;">No results found</div>
    <div id="searchResults"></div>

    <script>
        // Mock global variables from the main app
        let currentProducts = [];
        let allProducts = [];
        let currentView = 'grid';
        let currentGridLayout = 'standard';
        let searchStartTime = Date.now();

        // Mock functions that would be needed
        function filterCurrentProducts() {
            console.log('üîß filterCurrentProducts called, returning all products');
            return currentProducts;
        }

        function updateBrandFilter() {
            console.log('üîß updateBrandFilter called (mock)');
        }

        function generateStockStatus(product) {
            return { text: 'In Stock', class: 'in-stock' };
        }

        // Mock cart
        let cart = [];

        // The actual search functions from our main app (simplified for testing)
        function displaySearchResults(products, query) {
            console.log('üé® displaySearchResults() called with:', products?.length || 'NO PRODUCTS', 'products, query:', query);
            const resultsHeader = document.getElementById('searchResultsHeader');
            const noResultsState = document.getElementById('noResultsState');
            console.log('üé® DOM elements found - resultsHeader:', !!resultsHeader, 'noResultsState:', !!noResultsState);
            
            if (products && products.length > 0) {
                console.log('üé® CRITICAL: Products found, showing results header and updating UI');
                // Update results header
                updateResultsHeader(products, query);
                console.log('üé® CRITICAL: After updateResultsHeader, resultsHeader display should be visible');
                
                // Show results header
                if (resultsHeader) {
                    resultsHeader.style.display = 'block';
                    console.log('üé® CRITICAL: Set resultsHeader display to block');
                }
                
                // Hide no results state
                if (noResultsState) {
                    noResultsState.style.display = 'none';
                }
            } else {
                console.log('üé® No products found, showing no results state');
                if (resultsHeader) {
                    resultsHeader.style.display = 'none';
                }
                if (noResultsState) {
                    noResultsState.style.display = 'block';
                }
            }
        }

        function updateResultsHeader(products, query) {
            const resultsCount = document.getElementById('resultsCount');
            const searchTiming = document.getElementById('searchTiming');
            const searchQuery = document.getElementById('searchQuery');
            
            resultsCount.textContent = `${products.length} product${products.length !== 1 ? 's' : ''} found`;
            
            if (searchStartTime) {
                const searchTime = ((Date.now() - searchStartTime) / 1000).toFixed(2);
                searchTiming.textContent = `(${searchTime}s)`;
                searchTiming.style.display = 'inline';
            }
            
            if (query) {
                searchQuery.textContent = `for "${query}"`;
                searchQuery.style.display = 'inline';
            }
        }

        function displayProducts(products) {
            console.log('üó∫ displayProducts() called with:', products?.length || 'NO PRODUCTS', 'products');
            // If products are passed, update currentProducts and use them
            if (products) {
                currentProducts = products;
                console.log('üó∫ Updated currentProducts with', currentProducts.length, 'products');
            }
            
            const filtered = filterCurrentProducts();
            console.log('üó∫ After filtering, displaying', filtered.length, 'products in', currentView, 'view');
            
            if (currentView === 'grid') {
                console.log('üó∫ Calling displayGridView with', filtered.length, 'products');
                displayGridView(filtered);
            } else {
                console.log('üó∫ Calling displayTableView with', filtered.length, 'products');
                displayTableView(filtered);
            }
            console.log('üó∫ displayProducts() completed');
        }

        function displayGridView(products) {
            console.log('üó∫üó∫ displayGridView() called with', products?.length || 'NO PRODUCTS', 'products');
            const resultsDiv = document.getElementById('searchResults');
            if (!resultsDiv) {
                console.error('‚ùå‚ùå CRITICAL ERROR: SearchResults element not found in displayGridView');
                console.error('‚ùå‚ùå Available elements with similar IDs:', document.querySelectorAll('[id*="search"]'));
                return;
            }
            
            console.log('üó∫üó∫ Found searchResults element, clearing innerHTML and setting up grid');
            resultsDiv.innerHTML = '';
            
            // Set appropriate display based on current grid layout
            if (currentGridLayout === 'masonry') {
                resultsDiv.style.display = 'block';
                console.log('üó∫üó∫ Set masonry layout (block display)');
            } else {
                resultsDiv.style.display = 'grid';
                console.log('üó∫üó∫ Set grid layout (grid display)');
            }
            
            console.log('üó∫üó∫ About to create', products.length, 'product cards');
            products.forEach((product, index) => {
                console.log('üó∫üó∫ Creating card', index + 1, 'for product:', product?.name || 'UNNAMED PRODUCT');
                const card = createProductCard(product, index);
                if (card) {
                    resultsDiv.appendChild(card);
                    console.log('üó∫üó∫ Successfully appended card', index + 1, 'to resultsDiv');
                } else {
                    console.error('‚ùå‚ùå CRITICAL: createProductCard returned null/undefined for product:', product);
                }
            });
            console.log('üó∫üó∫ Finished creating all product cards. ResultsDiv innerHTML length:', resultsDiv.innerHTML.length);
            console.log('üó∫üó∫ ResultsDiv children count:', resultsDiv.children.length);
        }

        function createProductCard(product, index) {
            console.log('üÉè Creating product card for:', product?.name || 'UNNAMED', 'index:', index);
            
            if (!product) {
                console.error('‚ùå‚ùå CRITICAL: createProductCard called with null/undefined product');
                return null;
            }
            
            const card = document.createElement('div');
            const isOnSale = product.salePrice && product.salePrice > 0;
            card.className = isOnSale ? 'product-card premium-card on-sale' : 'product-card premium-card';
            console.log('üÉè Card element created with className:', card.className);

            const price = isOnSale ? product.salePrice : (product.price || 0);
            
            card.innerHTML = `
                <div class="product-header">
                    <h3>${product.name || 'Unnamed Product'}</h3>
                    <div class="product-price">$${price.toFixed(2)}</div>
                </div>
                <div class="product-details">
                    <p>Brand: ${product.brand || 'Unknown'}</p>
                    <p>Size: ${product.size || 'N/A'}</p>
                </div>
            `;
            
            console.log('üÉè Product card completed for:', product.name, 'innerHTML length:', card.innerHTML.length);
            
            return card;
        }

        // Test function
        function testSearch() {
            console.clear();
            console.log('üöÄ Starting search debug test...');
            
            // Create mock product data
            const mockProducts = [
                {
                    id: '1',
                    name: 'Organic Broccoli',
                    brand: 'Kroger',
                    size: '1 lb',
                    price: 2.99,
                    salePrice: 2.49
                },
                {
                    id: '2',
                    name: 'Organic Carrots',
                    brand: 'Simple Truth',
                    size: '2 lb bag',
                    price: 3.99,
                    salePrice: null
                },
                {
                    id: '3',
                    name: 'Organic Spinach',
                    brand: 'Simple Truth',
                    size: '5 oz',
                    price: 4.49,
                    salePrice: 3.99
                }
            ];

            const searchTerm = document.getElementById('searchTerm').value;
            searchStartTime = Date.now();
            
            // Log debug info
            addDebugMessage('üöÄ Test search started for: ' + searchTerm, 'success');
            addDebugMessage('üì¶ Mock products created: ' + mockProducts.length, 'success');
            
            // Test the search flow
            console.log('üß™ Testing displaySearchResults...');
            displaySearchResults(mockProducts, searchTerm);
            
            console.log('üß™ Testing displayProducts...');
            displayProducts(mockProducts);
            
            addDebugMessage('‚úÖ Search debug test completed! Check console and results below.', 'success');
        }

        function addDebugMessage(message, type = 'debug') {
            const debugOutput = document.getElementById('debugOutput');
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            debugOutput.appendChild(div);
        }

        // Run test on page load
        window.addEventListener('load', () => {
            addDebugMessage('üîß Debug page loaded. Ready to test search functionality.', 'success');
        });
    </script>
</body>
</html>