<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Refresh Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .log-output {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <h1>Store Refresh Debug Test</h1>
    
    <div class="test-section">
        <h2>1. Direct Function Test</h2>
        <input type="text" id="testZip" placeholder="Enter ZIP Code" value="45202">
        <button onclick="testDirectFunction()">Test findStores() Function</button>
        <button onclick="testRefreshButton()">Test Refresh Button Click</button>
        <div id="directStatus" class="status" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>2. API Test</h2>
        <button onclick="testAPI()">Test Store API Directly</button>
        <div id="apiStatus" class="status" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>3. UI Components Test</h2>
        <div style="margin: 20px 0;">
            <label>ZIP Code Input:</label>
            <input type="text" id="zipCode" placeholder="ZIP Code" value="45202">
        </div>
        <div style="margin: 20px 0;">
            <label>Store List:</label>
            <select id="storeList">
                <option value="">Loading stores...</option>
            </select>
        </div>
        <div style="margin: 20px 0;">
            <button id="findStoresBtn" onclick="findStores()">Find Stores (Original)</button>
            <button class="refresh-stores-btn" onclick="findStores()">Refresh Stores</button>
            <button onclick="simulateRefreshClick()">Simulate Refresh Click</button>
        </div>
        <div id="uiStatus" class="status" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>4. Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="checkGlobalFunctions()">Check Global Functions</button>
        <button onclick="checkButtonHandlers()">Check Button Event Handlers</button>
        <div id="debugLog" class="log-output"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        };

        const showStatus = (elementId, message, type = 'info') => {
            const statusDiv = document.getElementById(elementId);
            statusDiv.style.display = 'block';
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        };

        const clearLog = () => {
            document.getElementById('debugLog').innerHTML = '';
            log('Log cleared');
        };

        const testDirectFunction = async () => {
            log('Testing direct findStores() function call...');
            
            // First check if the function exists
            if (typeof findStores === 'undefined') {
                log('ERROR: findStores is not defined in global scope!', 'error');
                showStatus('directStatus', 'findStores function not found!', 'error');
                
                // Try to load app.js if not loaded
                log('Attempting to load app.js...');
                const script = document.createElement('script');
                script.src = '/app.js';
                script.onload = () => {
                    log('app.js loaded, retrying...', 'success');
                    if (typeof findStores !== 'undefined') {
                        log('findStores now available!', 'success');
                        testDirectFunction();
                    }
                };
                script.onerror = () => {
                    log('Failed to load app.js', 'error');
                };
                document.head.appendChild(script);
                return;
            }
            
            // Set the ZIP code
            const zipInput = document.getElementById('zipCode');
            const testZip = document.getElementById('testZip').value;
            if (zipInput) {
                zipInput.value = testZip;
                log(`Set ZIP code to: ${testZip}`);
            } else {
                log('WARNING: zipCode input element not found', 'error');
            }
            
            try {
                log('Calling findStores()...');
                await findStores();
                log('findStores() completed successfully', 'success');
                showStatus('directStatus', 'Function executed successfully!', 'success');
                
                // Check the store list
                const storeList = document.getElementById('storeList');
                if (storeList) {
                    log(`Store list has ${storeList.options.length} options`);
                    if (storeList.options.length > 0) {
                        log(`First store: ${storeList.options[0].text}`);
                    }
                }
            } catch (error) {
                log(`ERROR calling findStores(): ${error.message}`, 'error');
                showStatus('directStatus', `Error: ${error.message}`, 'error');
            }
        };

        const testRefreshButton = () => {
            log('Testing refresh button click simulation...');
            
            const refreshBtn = document.querySelector('.refresh-stores-btn');
            if (refreshBtn) {
                log('Found refresh button, triggering click...');
                refreshBtn.click();
                log('Click event triggered', 'success');
                showStatus('directStatus', 'Refresh button clicked!', 'success');
            } else {
                log('ERROR: Refresh button not found!', 'error');
                showStatus('directStatus', 'Refresh button not found!', 'error');
            }
        };

        const testAPI = async () => {
            log('Testing store API endpoint directly...');
            const testZip = document.getElementById('testZip').value;
            
            try {
                log(`Fetching stores for ZIP: ${testZip}`);
                const response = await fetch(`/api/stores/nearby?zipCode=${testZip}&radius=50`);
                
                log(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stores = await response.json();
                log(`API returned ${stores.length} stores`, 'success');
                
                if (stores.length > 0) {
                    log(`First store: ${stores[0].name} - ${stores[0].address.city}`);
                }
                
                showStatus('apiStatus', `API working! Found ${stores.length} stores`, 'success');
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                showStatus('apiStatus', `API Error: ${error.message}`, 'error');
            }
        };

        const simulateRefreshClick = () => {
            log('Simulating refresh button click with event details...');
            
            const refreshBtn = document.querySelector('.refresh-stores-btn');
            if (!refreshBtn) {
                log('ERROR: Refresh button not found', 'error');
                return;
            }
            
            // Log button properties
            log(`Button onclick: ${refreshBtn.onclick}`);
            log(`Button getAttribute('onclick'): ${refreshBtn.getAttribute('onclick')}`);
            
            // Try different click methods
            try {
                // Method 1: Direct click
                log('Method 1: Direct click()');
                refreshBtn.click();
                
                // Method 2: Dispatch event
                log('Method 2: Dispatching click event');
                const clickEvent = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                refreshBtn.dispatchEvent(clickEvent);
                
                // Method 3: Call onclick directly
                if (refreshBtn.onclick) {
                    log('Method 3: Calling onclick directly');
                    refreshBtn.onclick();
                }
                
                log('All click methods executed', 'success');
            } catch (error) {
                log(`Click simulation error: ${error.message}`, 'error');
            }
        };

        const checkGlobalFunctions = () => {
            log('Checking global functions...');
            
            const functions = [
                'findStores',
                'selectStore',
                'searchProducts',
                'showTab',
                'ButtonStateManager',
                'SkeletonLoader'
            ];
            
            functions.forEach(funcName => {
                const exists = typeof window[funcName] !== 'undefined';
                const type = typeof window[funcName];
                log(`${funcName}: ${exists ? `✓ (${type})` : '✗ NOT FOUND'}`, exists ? 'success' : 'error');
            });
        };

        const checkButtonHandlers = () => {
            log('Checking button event handlers...');
            
            const buttons = [
                { selector: '#findStoresBtn', name: 'Find Stores Button' },
                { selector: '.refresh-stores-btn', name: 'Refresh Button' },
                { selector: '.find-stores-btn', name: 'Find Stores (class)' }
            ];
            
            buttons.forEach(({ selector, name }) => {
                const btn = document.querySelector(selector);
                if (btn) {
                    log(`${name}: Found`);
                    log(`  - onclick: ${btn.onclick || 'null'}`);
                    log(`  - getAttribute('onclick'): ${btn.getAttribute('onclick') || 'null'}`);
                    
                    // Check event listeners
                    const listeners = getEventListeners ? getEventListeners(btn) : null;
                    if (listeners) {
                        log(`  - Event listeners: ${JSON.stringify(Object.keys(listeners))}`);
                    }
                } else {
                    log(`${name}: NOT FOUND`, 'error');
                }
            });
        };

        // Initial log
        log('Debug test page loaded');
        log('Checking initial environment...');
        
        // Check if app.js is loaded
        if (typeof findStores === 'undefined') {
            log('WARNING: app.js not loaded, loading now...', 'error');
            const script = document.createElement('script');
            script.src = '/app.js';
            script.onload = () => {
                log('app.js loaded successfully', 'success');
                checkGlobalFunctions();
            };
            script.onerror = () => {
                log('Failed to load app.js', 'error');
            };
            document.head.appendChild(script);
        } else {
            log('app.js already loaded', 'success');
            checkGlobalFunctions();
        }
    </script>
</body>
</html>