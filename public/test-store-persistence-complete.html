<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Persistence - Complete Test Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .test-card h3 {
            margin-top: 0;
            color: #0066cc;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0052a3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        .test-log .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .test-log .success {
            color: #28a745;
        }
        .test-log .error {
            color: #dc3545;
        }
        .test-log .warning {
            color: #ffc107;
        }
        .test-log .info {
            color: #17a2b8;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #dee2e6;
        }
        .test-result.pass {
            border-left-color: #28a745;
            background: #f8fff9;
        }
        .test-result.fail {
            border-left-color: #dc3545;
            background: #fff8f8;
        }
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <h1>Store Persistence - Complete Test Suite</h1>
    
    <div class="test-section">
        <h2>System Status</h2>
        <div class="test-grid">
            <div class="test-card">
                <h3>Components Status</h3>
                <div id="componentsStatus"></div>
            </div>
            <div class="test-card">
                <h3>Current Store</h3>
                <div id="currentStoreDisplay"></div>
            </div>
            <div class="test-card">
                <h3>Migration Status</h3>
                <div id="migrationStatus"></div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <div>
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="testStoreLoading()">Test Store Loading</button>
            <button onclick="testStoreSaving()">Test Store Saving</button>
            <button onclick="testCrossTabSync()">Test Cross-Tab Sync</button>
            <button onclick="testToastFiltering()">Test Toast Filtering</button>
            <button onclick="testMigration()">Test Migration</button>
            <button onclick="testRaceConditions()">Test Race Conditions</button>
            <button class="danger" onclick="clearAllData()">Clear All Data</button>
            <button class="success" onclick="setupTestStore()">Setup Test Store</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="testResults"></div>
    </div>
    
    <div class="test-section">
        <h2>localStorage Data</h2>
        <button onclick="refreshDataDisplay()">Refresh Display</button>
        <div id="localStorageDisplay" class="data-display"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="testLog" class="test-log"></div>
    </div>
    
    <!-- Include all the scripts -->
    <script src="js/store-migration.js"></script>
    <script src="js/StoreManager.js"></script>
    <script src="js/ToastManager.js"></script>
    <script src="js/InitializationManager.js"></script>
    <script src="js/store-persistence-integration.js"></script>
    <script src="js/store-persistence-fix.js"></script>
    
    <script>
        // Test logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TestSuite] ${message}`);
        }
        
        // Update status displays
        function updateStatus() {
            // Components status
            const componentsDiv = document.getElementById('componentsStatus');
            componentsDiv.innerHTML = `
                <p>StoreManager: <span class="status ${window.storeManager ? 'success' : 'error'}">${window.storeManager ? 'Loaded' : 'Not Loaded'}</span></p>
                <p>ToastManager: <span class="status ${window.toastManager ? 'success' : 'error'}">${window.toastManager ? 'Loaded' : 'Not Loaded'}</span></p>
                <p>InitManager: <span class="status ${window.initManager ? 'success' : 'error'}">${window.initManager ? 'Loaded' : 'Not Loaded'}</span></p>
                <p>StoreFix: <span class="status ${window.storePersistenceFixStatus ? 'success' : 'error'}">${window.storePersistenceFixStatus ? 'Loaded' : 'Not Loaded'}</span></p>
            `;
            
            // Current store
            const storeDiv = document.getElementById('currentStoreDisplay');
            if (window.storeManager) {
                const store = window.storeManager.getStore();
                if (store) {
                    storeDiv.innerHTML = `
                        <p><strong>${store.name}</strong></p>
                        <p>ID: ${store.id}</p>
                        <p>Address: ${store.address || 'N/A'}</p>
                        <p>Phone: ${store.phone || 'N/A'}</p>
                    `;
                } else {
                    storeDiv.innerHTML = '<p class="status warning">No store selected</p>';
                }
            } else {
                storeDiv.innerHTML = '<p class="status error">StoreManager not loaded</p>';
            }
            
            // Migration status
            const migrationDiv = document.getElementById('migrationStatus');
            if (window.storeMigrationStatus) {
                migrationDiv.innerHTML = `
                    <p>Version: ${window.storeMigrationStatus.version}</p>
                    <p>Needs Migration: <span class="status ${window.storeMigrationStatus.needsMigration() ? 'warning' : 'success'}">${window.storeMigrationStatus.needsMigration() ? 'Yes' : 'No'}</span></p>
                `;
            } else {
                migrationDiv.innerHTML = '<p class="status error">Migration not loaded</p>';
            }
            
            refreshDataDisplay();
        }
        
        // Refresh localStorage display
        function refreshDataDisplay() {
            const display = document.getElementById('localStorageDisplay');
            const storeKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('store') || key.includes('Store') || key.includes('kroger')) {
                    storeKeys.push(key);
                }
            }
            
            storeKeys.sort();
            
            let content = 'Store-related localStorage keys:\n\n';
            storeKeys.forEach(key => {
                const value = localStorage.getItem(key);
                content += `${key}: ${value}\n`;
            });
            
            if (storeKeys.length === 0) {
                content = 'No store-related data in localStorage';
            }
            
            display.textContent = content;
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            log('Log cleared');
        }
        
        // Test functions
        async function testStoreLoading() {
            log('Testing store loading...', 'info');
            const resultsDiv = document.getElementById('testResults');
            
            try {
                if (!window.storeManager) {
                    throw new Error('StoreManager not available');
                }
                
                await window.storeManager.initialize();
                const store = window.storeManager.getStore();
                
                const result = document.createElement('div');
                result.className = store ? 'test-result pass' : 'test-result fail';
                result.innerHTML = `
                    <h4>Store Loading Test</h4>
                    <p>Result: ${store ? 'PASS - Store loaded' : 'FAIL - No store found'}</p>
                    ${store ? `<p>Store: ${store.name} (ID: ${store.id})</p>` : ''}
                `;
                resultsDiv.appendChild(result);
                
                log(store ? `Store loaded: ${store.name}` : 'No store found', store ? 'success' : 'warning');
                
            } catch (error) {
                log(`Store loading test failed: ${error.message}`, 'error');
            }
            
            updateStatus();
        }
        
        async function testStoreSaving() {
            log('Testing store saving...', 'info');
            const resultsDiv = document.getElementById('testResults');
            
            try {
                if (!window.storeManager) {
                    throw new Error('StoreManager not available');
                }
                
                const testStore = {
                    id: 'test-123',
                    locationId: 'test-123',
                    name: 'Test Store Cincinnati',
                    address: '123 Test St, Cincinnati, OH 45202',
                    phone: '513-555-0123',
                    division: 'test'
                };
                
                await window.storeManager.setStore(testStore);
                const savedStore = window.storeManager.getStore();
                
                const result = document.createElement('div');
                result.className = savedStore && savedStore.id === testStore.id ? 'test-result pass' : 'test-result fail';
                result.innerHTML = `
                    <h4>Store Saving Test</h4>
                    <p>Result: ${savedStore && savedStore.id === testStore.id ? 'PASS' : 'FAIL'}</p>
                    <p>Saved store ID: ${savedStore ? savedStore.id : 'none'}</p>
                `;
                resultsDiv.appendChild(result);
                
                log(savedStore ? 'Store saved successfully' : 'Store save failed', savedStore ? 'success' : 'error');
                
            } catch (error) {
                log(`Store saving test failed: ${error.message}`, 'error');
            }
            
            updateStatus();
        }
        
        function testCrossTabSync() {
            log('Testing cross-tab sync...', 'info');
            const resultsDiv = document.getElementById('testResults');
            
            const result = document.createElement('div');
            result.className = 'test-result info';
            result.innerHTML = `
                <h4>Cross-Tab Sync Test</h4>
                <p>Open this page in another tab and change the store.</p>
                <p>This tab should automatically update.</p>
            `;
            resultsDiv.appendChild(result);
            
            // Listen for sync events
            if (window.storeManager) {
                window.storeManager.addEventListener('store-synced', (store) => {
                    log(`Store synced from another tab: ${store ? store.name : 'cleared'}`, 'success');
                    updateStatus();
                });
            }
        }
        
        function testToastFiltering() {
            log('Testing toast filtering...', 'info');
            
            // Try to trigger a "store not set" message when store exists
            if (window.storeManager && window.storeManager.hasStore()) {
                const store = window.storeManager.getStore();
                log(`Current store: ${store.name}`, 'info');
                
                // This should be filtered out
                if (window.showToast) {
                    window.showToast('Store not selected', 'error');
                    log('Attempted to show "Store not selected" - should be filtered', 'warning');
                }
                
                // This should show
                if (window.toastManager) {
                    window.toastManager.showSuccess('Test', 'This toast should appear');
                    log('Showed success toast', 'success');
                }
            } else {
                log('No store set, cannot test filtering', 'warning');
            }
        }
        
        function testMigration() {
            log('Testing migration...', 'info');
            const resultsDiv = document.getElementById('testResults');
            
            // Set some legacy data
            localStorage.setItem('defaultStoreId', 'legacy-001');
            localStorage.setItem('defaultStoreName', 'Legacy Store');
            localStorage.setItem('defaultStoreAddress', '456 Old St');
            
            // Run migration
            if (window.storeMigrationStatus) {
                window.storeMigrationStatus.performMigration();
                
                // Check if data was migrated
                const newId = localStorage.getItem('kroger_store_id');
                const newName = localStorage.getItem('kroger_store_name');
                
                const result = document.createElement('div');
                result.className = newId === 'legacy-001' ? 'test-result pass' : 'test-result fail';
                result.innerHTML = `
                    <h4>Migration Test</h4>
                    <p>Result: ${newId === 'legacy-001' ? 'PASS' : 'FAIL'}</p>
                    <p>Migrated ID: ${newId}</p>
                    <p>Migrated Name: ${newName}</p>
                `;
                resultsDiv.appendChild(result);
                
                log(newId === 'legacy-001' ? 'Migration successful' : 'Migration failed', newId === 'legacy-001' ? 'success' : 'error');
            } else {
                log('Migration utility not available', 'error');
            }
            
            updateStatus();
        }
        
        async function testRaceConditions() {
            log('Testing race conditions...', 'info');
            const resultsDiv = document.getElementById('testResults');
            
            let success = true;
            const results = [];
            
            // Simulate multiple simultaneous operations
            const promises = [];
            
            // Operation 1: Load store
            promises.push(
                window.storeManager.initialize().then(() => {
                    results.push('Initialize completed');
                })
            );
            
            // Operation 2: Save store
            promises.push(
                window.storeManager.setStore({
                    id: 'race-001',
                    locationId: 'race-001',
                    name: 'Race Test Store',
                    address: '789 Race St',
                    phone: '555-RACE'
                }).then(() => {
                    results.push('Save completed');
                })
            );
            
            // Operation 3: Load store again
            promises.push(
                window.storeManager.loadStore().then(() => {
                    results.push('Load completed');
                })
            );
            
            try {
                await Promise.all(promises);
                
                const finalStore = window.storeManager.getStore();
                success = finalStore && finalStore.id === 'race-001';
                
                const result = document.createElement('div');
                result.className = success ? 'test-result pass' : 'test-result fail';
                result.innerHTML = `
                    <h4>Race Conditions Test</h4>
                    <p>Result: ${success ? 'PASS' : 'FAIL'}</p>
                    <p>Operations completed: ${results.join(', ')}</p>
                    <p>Final store: ${finalStore ? finalStore.name : 'none'}</p>
                `;
                resultsDiv.appendChild(result);
                
                log(success ? 'Race conditions handled correctly' : 'Race condition issues detected', success ? 'success' : 'error');
                
            } catch (error) {
                log(`Race condition test failed: ${error.message}`, 'error');
            }
            
            updateStatus();
        }
        
        async function runAllTests() {
            log('Running all tests...', 'info');
            document.getElementById('testResults').innerHTML = '';
            
            await testStoreLoading();
            await testStoreSaving();
            testCrossTabSync();
            testToastFiltering();
            testMigration();
            await testRaceConditions();
            
            log('All tests completed', 'success');
        }
        
        function clearAllData() {
            if (confirm('This will clear all store data. Are you sure?')) {
                if (window.clearAllStoreData) {
                    window.clearAllStoreData();
                } else {
                    // Manual clear
                    const keys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.includes('store') || key.includes('Store') || key.includes('kroger')) {
                            keys.push(key);
                        }
                    }
                    keys.forEach(key => localStorage.removeItem(key));
                }
                
                log('All store data cleared', 'warning');
                updateStatus();
            }
        }
        
        async function setupTestStore() {
            log('Setting up test store...', 'info');
            
            if (!window.storeManager) {
                log('StoreManager not available', 'error');
                return;
            }
            
            const testStore = {
                id: '01100201',
                locationId: '01100201',
                name: 'Kroger - Cincinnati Downtown',
                address: '100 E Court St, Cincinnati, OH 45202',
                phone: '513-555-1234',
                division: '014'
            };
            
            try {
                await window.storeManager.setStore(testStore);
                log(`Test store set: ${testStore.name}`, 'success');
                
                if (window.toastManager) {
                    window.toastManager.showSuccess('Store Set', `Now using ${testStore.name}`);
                }
                
                updateStatus();
            } catch (error) {
                log(`Failed to set test store: ${error.message}`, 'error');
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateStatus();
                log('Test suite ready', 'success');
            }, 1000);
        });
        
        // Update status every 5 seconds
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>