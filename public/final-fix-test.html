<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Fix Test - Direct Search</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0052a3; }
        #console {
            background: #1e1e1e;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Final Fix Test - Testing Search Chain</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runFullTest()">Run Complete Test</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console"></div>
    </div>

    <div class="test-section">
        <h2>Search Results Preview</h2>
        <div id="searchResults" class="product-grid"></div>
    </div>

    <!-- Hidden required elements -->
    <div style="display:none">
        <input id="searchTerm" value="milk">
        <div id="searchResultsHeader"></div>
        <div id="tableResults"></div>
        <div id="noResultsState"></div>
        <div id="resultsViewControls"></div>
        <div id="filtersContainer"></div>
        <div id="quickFilterButtons"></div>
        <div id="categoryFilters"></div>
    </div>

    <script>
        const consoleDiv = document.getElementById('console');
        const logs = [];
        
        // Override console methods
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('ERROR', args.join(' '));
        };
        
        function addToConsole(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'ERROR' ? '#f00' : '#0f0';
            logs.push(`<span style="color: ${color}">[${timestamp}] ${type}: ${message}</span>`);
            consoleDiv.innerHTML = logs.slice(-50).join('<br>');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearConsole() {
            logs.length = 0;
            consoleDiv.innerHTML = '';
        }
        
        async function runFullTest() {
            clearConsole();
            addToConsole('TEST', '=== STARTING FULL TEST SEQUENCE ===');
            
            // Step 1: Set globals
            addToConsole('TEST', 'Step 1: Setting global variables...');
            window.selectedStoreId = '70100154';
            window.selectedStoreName = 'Test Store';
            window.currentView = 'grid';
            window.currentProducts = [];
            window.allProducts = [];
            
            // Step 2: Load app.js
            addToConsole('TEST', 'Step 2: Loading app.js...');
            
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = '/app.js?t=' + Date.now();
                
                script.onload = async () => {
                    addToConsole('SUCCESS', 'app.js loaded successfully');
                    
                    // Step 3: Check functions
                    addToConsole('TEST', 'Step 3: Checking required functions...');
                    const functions = ['searchProducts', 'displaySearchResults', 'displayProducts', 'displayGridView', 'createProductCard'];
                    
                    functions.forEach(fn => {
                        if (typeof window[fn] === 'function') {
                            addToConsole('SUCCESS', `✓ ${fn} exists`);
                        } else {
                            addToConsole('ERROR', `✗ ${fn} missing`);
                        }
                    });
                    
                    // Step 4: Direct API test
                    addToConsole('TEST', 'Step 4: Testing API directly...');
                    try {
                        const response = await fetch('/api/products/search?term=milk&locationId=70100154&limit=3');
                        const products = await response.json();
                        addToConsole('SUCCESS', `API returned ${products.length} products`);
                        
                        // Step 5: Test display functions directly
                        addToConsole('TEST', 'Step 5: Testing display functions with API data...');
                        
                        if (typeof window.displaySearchResults === 'function') {
                            window.displaySearchResults(products, 'milk');
                            addToConsole('SUCCESS', 'displaySearchResults executed');
                        }
                        
                        if (typeof window.displayProducts === 'function') {
                            window.currentProducts = products;
                            window.allProducts = [...products];
                            window.displayProducts(products);
                            addToConsole('SUCCESS', 'displayProducts executed');
                        }
                        
                        // Step 6: Check DOM results
                        addToConsole('TEST', 'Step 6: Checking DOM for rendered products...');
                        const searchResults = document.getElementById('searchResults');
                        const productCards = searchResults.querySelectorAll('.product-card');
                        
                        if (productCards.length > 0) {
                            addToConsole('SUCCESS', `✓ ${productCards.length} product cards rendered!`);
                        } else {
                            addToConsole('ERROR', '✗ No product cards found in DOM');
                            addToConsole('DEBUG', 'searchResults innerHTML length: ' + searchResults.innerHTML.length);
                        }
                        
                        // Step 7: Test searchProducts function
                        addToConsole('TEST', 'Step 7: Testing searchProducts function...');
                        if (typeof window.searchProducts === 'function') {
                            document.getElementById('searchTerm').value = 'bread';
                            await window.searchProducts();
                            addToConsole('SUCCESS', 'searchProducts completed');
                            
                            const newCards = searchResults.querySelectorAll('.product-card');
                            addToConsole('INFO', `Found ${newCards.length} cards after searchProducts`);
                        }
                        
                    } catch (error) {
                        addToConsole('ERROR', 'API test failed: ' + error.message);
                    }
                    
                    addToConsole('TEST', '=== TEST SEQUENCE COMPLETE ===');
                    resolve();
                };
                
                script.onerror = () => {
                    addToConsole('ERROR', 'Failed to load app.js');
                    resolve();
                };
                
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>